@page
@model PriceWatcher.Pages.CartModel
@{
    ViewData["Title"] = "Gi·ªè h√†ng";
}

<div class="cart-page">
    <div class="container">
        <div class="cart-header">
            <h1>Gi·ªè h√†ng c·ªßa b·∫°n</h1>
        </div>

        <div class="row">
            <!-- Cart Items -->
            <div class="col-lg-8">
                <div id="cartItemsContainer">
                    <!-- Items will be loaded here by JavaScript -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="col-lg-4">
                <div class="cart-summary" id="cartSummary">
                    <h3>T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
                    <div class="summary-row">
                        <span>T·∫°m t√≠nh:</span>
                        <span id="subtotal">0‚Ç´</span>
                    </div>
                    <div class="summary-row">
                        <span>Gi·∫£m gi√°:</span>
                        <span id="discount" class="text-success">0‚Ç´</span>
                    </div>
                    <div class="summary-row">
                        <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                        <span id="shipping">Mi·ªÖn ph√≠</span>
                    </div>
                    <div class="summary-row total">
                        <span>T·ªïng c·ªông:</span>
                        <span id="total" class="text-danger">0‚Ç´</span>
                    </div>
                    <button class="checkout-btn" id="checkoutBtn" disabled>
                        Ti·∫øn h√†nh thanh to√°n
                    </button>
                    <div class="text-center mt-3">
                        <a href="/" class="text-decoration-none">
                            <small>‚Üê Ti·∫øp t·ª•c mua s·∫Øm</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Render cart items
        function renderCart() {
            const container = document.getElementById('cartItemsContainer');
            const items = window.cart.getItems();

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="cart-empty">
                        <div class="cart-empty-icon">üõí</div>
                        <h3>Gi·ªè h√†ng tr·ªëng</h3>
                        <p>B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè h√†ng</p>
                        <a href="/" class="btn btn-primary">Kh√°m ph√° s·∫£n ph·∫©m</a>
                    </div>
                `;
                updateSummary();
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="cart-item" data-product-id="${item.productId}" data-platform-id="${item.platformId}">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <img src="${item.imageUrl}" alt="${item.name}" class="cart-item-image">
                        </div>
                        <div class="col">
                            <div class="cart-item-details">
                                <span class="cart-item-platform">${item.platformName}</span>
                                <h5 class="cart-item-name">${item.name}</h5>
                                <div class="cart-item-price">
                                    ${formatCurrency(item.price)}
                                    ${item.originalPrice ? `<span class="cart-item-original-price">${formatCurrency(item.originalPrice)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="d-flex flex-column align-items-end gap-3">
                                <div class="quantity-control">
                                    <button class="quantity-btn" onclick="updateQuantity(${item.productId}, ${item.platformId}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>
                                        ‚àí
                                    </button>
                                    <input type="number" 
                                           class="quantity-input" 
                                           value="${item.quantity}" 
                                           min="1" 
                                           max="99"
                                           onchange="updateQuantity(${item.productId}, ${item.platformId}, this.value)">
                                    <button class="quantity-btn" onclick="updateQuantity(${item.productId}, ${item.platformId}, ${item.quantity + 1})" ${item.quantity >= 99 ? 'disabled' : ''}>
                                        +
                                    </button>
                                </div>
                                <button class="remove-item-btn" onclick="removeItem(${item.productId}, ${item.platformId})">
                                    X√≥a
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            updateSummary();
        }

        // Update cart summary
        function updateSummary() {
            const items = window.cart.getItems();
            const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discount = items.reduce((sum, item) => {
                if (item.originalPrice) {
                    return sum + ((item.originalPrice - item.price) * item.quantity);
                }
                return sum;
            }, 0);
            const shipping = 0; // Free shipping
            const total = subtotal;

            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('discount').textContent = discount > 0 ? `-${formatCurrency(discount)}` : '0‚Ç´';
            document.getElementById('shipping').textContent = shipping === 0 ? 'Mi·ªÖn ph√≠' : formatCurrency(shipping);
            document.getElementById('total').textContent = formatCurrency(total);

            const checkoutBtn = document.getElementById('checkoutBtn');
            checkoutBtn.disabled = items.length === 0;
        }

        // Update quantity
        function updateQuantity(productId, platformId, quantity) {
            window.cart.updateQuantity(productId, platformId, quantity);
            renderCart();
        }

        // Remove item
        function removeItem(productId, platformId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
                window.cart.removeItem(productId, platformId);
                renderCart();
            }
        }

        // Checkout
        document.getElementById('checkoutBtn')?.addEventListener('click', function() {
            const items = window.cart.getItems();
            if (items.length === 0) return;

            // Redirect to checkout page or show checkout modal
            alert('Ch·ª©c nƒÉng thanh to√°n ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
            // window.location.href = '/checkout';
        });

        // Listen for cart updates
        window.addEventListener('cartUpdated', function() {
            renderCart();
        });

        // Initial render
        document.addEventListener('DOMContentLoaded', function() {
            renderCart();
        });
    </script>
}
