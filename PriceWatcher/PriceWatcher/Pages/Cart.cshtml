@page
@model PriceWatcher.Pages.CartModel
@{
    ViewData["Title"] = "Gi·ªè h√†ng";
}

<div class="cart-page">
    <div class="container">
        <!-- Header: Tiki style title and actions -->
        <div class="cart-header d-flex align-items-center justify-content-between">
            <h1 class="m-0" style="color:#1a94ff;">Gi·ªè h√†ng</h1>
            <div class="d-flex gap-2">
                <a href="/" class="btn btn-link text-decoration-none">‚Üê Ti·∫øp t·ª•c mua s·∫Øm</a>
                <button id="updateCartBtn" class="btn btn-outline-primary d-none">C·∫≠p nh·∫≠t gi·ªè h√†ng</button>
            </div>
        </div>

        <!-- Mobile Summary Accordion -->
        <div class="d-lg-none mb-3">
            <div class="accordion" id="summaryAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="summaryHeading">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#summaryCollapse" aria-expanded="false" aria-controls="summaryCollapse">
                            T√≥m t·∫Øt ƒë∆°n h√†ng
                        </button>
                    </h2>
                    <div id="summaryCollapse" class="accordion-collapse collapse" aria-labelledby="summaryHeading" data-bs-parent="#summaryAccordion">
                        <div class="accordion-body">
                            <div class="summary-row">
                                <span>T·∫°m t√≠nh:</span>
                                <span id="m-subtotal">0‚Ç´</span>
                            </div>
                            <div class="summary-row">
                                <span>Gi·∫£m gi√°:</span>
                                <span id="m-discount" class="text-success">0‚Ç´</span>
                            </div>
                            <div class="summary-row">
                                <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                                <span id="m-shipping">Mi·ªÖn ph√≠</span>
                            </div>
                            <div class="summary-row total">
                                <span>T·ªïng c·ªông:</span>
                                <span id="m-total" class="text-danger">0‚Ç´</span>
                            </div>
                         
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Cart Items -->
            <div class="col-lg-8">
                <div class="bg-white rounded-3 p-3 mb-3 shadow-sm d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-3">
                        <input type="checkbox" id="selectAll" class="form-check-input">
                        <label for="selectAll" class="form-check-label fw-semibold">Ch·ªçn t·∫•t c·∫£</label>
                    </div>
                    <button id="removeSelectedBtn" class="btn btn-outline-danger btn-sm" disabled>
                        X√≥a ƒë√£ ch·ªçn
                    </button>
                </div>

                <div id="cartItemsContainer">
                    <!-- Skeletons while loading -->
                    <div class="cart-skeleton-list">
                        <div class="cart-skeleton-item"></div>
                        <div class="cart-skeleton-item"></div>
                        <div class="cart-skeleton-item"></div>
                    </div>
                </div>
            </div>

            <!-- Cart Summary Desktop -->
            <div class="col-lg-4 d-none d-lg-block">
                <div class="cart-summary" id="cartSummary">
                    <h3>T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
                    <div class="summary-row">
                        <span>T·∫°m t√≠nh:</span>
                        <span id="subtotal">0‚Ç´</span>
                    </div>
                    <div class="summary-row">
                        <span>Gi·∫£m gi√°:</span>
                        <span id="discount" class="text-success">0‚Ç´</span>
                    </div>
                    <div class="summary-row">
                        <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                        <span id="shipping">Mi·ªÖn ph√≠</span>
                    </div>
                    <div class="summary-row">
                        <span>Ti·∫øt ki·ªám:</span>
                        <span id="saving" class="text-success">0‚Ç´</span>
                    </div>
                    <div class="summary-row total">
                        <span>T·ªïng c·ªông:</span>
                        <span id="total" class="text-danger">0‚Ç´</span>
                    </div>
                 
                    <div class="text-center mt-3">
                        <a href="/" class="text-decoration-none"><small>‚Üê Ti·∫øp t·ª•c mua s·∫Øm</small></a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Remove Confirmation Modal -->
    <div class="modal fade" id="removeConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">X√≥a s·∫£n ph·∫©m</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                </div>
                <div class="modal-body">
                    B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a <span id="removeItemName" class="fw-semibold"></span> kh·ªèi gi·ªè h√†ng?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-danger" id="confirmRemoveBtn">X√≥a</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá VND
        const currencyFormatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
        function formatCurrency(amount) { return currencyFormatter.format(amount || 0); }

        const selectedKeys = new Set();
        const getKey = (item) => `${item.productId}:${item.platformId ?? 'null'}`;

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m
        async function updateQuantity(productId, platformId, quantity) {
            if (!window.cartClient) return;
            await window.cartClient.updateQuantity(productId, platformId, Number(quantity));
        }

        // M·ªü modal x√°c nh·∫≠n x√≥a s·∫£n ph·∫©m
        let pendingRemove = null;
        async function removeItem(productId, platformId, name) {
            if (!window.cartClient) return;
            pendingRemove = { productId, platformId };
            const nameEl = document.getElementById('removeItemName');
            if (nameEl) nameEl.textContent = name || '';
            const modal = new bootstrap.Modal(document.getElementById('removeConfirmModal'));
            modal.show();
        }

        // Render giao di·ªán gi·ªè h√†ng v√† t√≥m t·∫Øt
        function renderCart(state) {
            const cartState = state || { items: window.cartClient?.items ?? [], summary: window.cartClient?.summary ?? {} };
            const items = cartState.items || [];
            const container = document.getElementById('cartItemsContainer');
            if (!container) return;

            // Tr·∫°ng th√°i gi·ªè h√†ng tr·ªëng
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="cart-empty">
                        <div class="cart-empty-icon">üõí</div>
                        <h3>Gi·ªè h√†ng tr·ªëng</h3>
                        <p>B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè h√†ng</p>
                        <a href="/" class="btn btn-primary">Kh√°m ph√° s·∫£n ph·∫©m</a>
                    </div>
                `;
            } else {
                // Hi·ªÉn th·ªã t·ª´ng item v·ªõi h√¨nh ·∫£nh, gi√°, s·ªë l∆∞·ª£ng, v√† n√∫t x√≥a
                container.innerHTML = items.map((item, idx) => {
                    const key = getKey(item);
                    const hasDiscount = item.originalPrice && item.originalPrice > item.price;
                    const discountPercent = hasDiscount ? Math.round(((item.originalPrice - item.price) / item.originalPrice) * 100) : 0;
                    const subtotal = (item.price || 0) * (item.quantity || 0);
                    return `
                    <div class="cart-item animate-in" data-product-id="${item.productId}" data-platform-id="${item.platformId}">
                        <div class="row align-items-center g-3">
                            <div class="col-auto d-flex align-items-center gap-3">
                                <input type="checkbox" class="form-check-input item-select" data-index="${idx}" data-key="${key}" ${selectedKeys.has(key) ? 'checked' : ''}>
                                <img src="${item.imageUrl || '/images/placeholder.png'}" alt="${item.name}" class="cart-item-image" loading="lazy">
                            </div>
                            <div class="col">
                                <div class="cart-item-details">
                                    <span class="cart-item-platform">${item.platformName || ''}</span>
                                    <h5 class="cart-item-name">${item.name}</h5>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="cart-item-price">
                                            ${formatCurrency(item.price)}
                                            ${item.originalPrice ? `<span class=\"cart-item-original-price\">${formatCurrency(item.originalPrice)}</span>` : ''}
                                        </div>
                                        ${hasDiscount ? `<span class=\"discount-badge\">-${discountPercent}%</span>` : ''}
                                    </div>
                                    <div class="item-subtotal">T·∫°m t√≠nh: <span>${formatCurrency(subtotal)}</span></div>
                                    <div class="text-muted small">V·∫≠n chuy·ªÉn: Mi·ªÖn ph√≠</div>
                                </div>
                            </div>
                            <div class="col-auto">
                                <div class="d-flex flex-column align-items-end gap-3">
                                    <div class="quantity-control">
                                        <button class="quantity-btn" onclick="updateQuantity(${item.productId}, ${item.platformId ?? 'null'}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>‚àí</button>
                                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="99"
                                               oninput="document.getElementById('updateCartBtn')?.classList.remove('d-none')"
                                               onchange="updateQuantity(${item.productId}, ${item.platformId ?? 'null'}, this.value)">
                                        <button class="quantity-btn" onclick="updateQuantity(${item.productId}, ${item.platformId ?? 'null'}, ${item.quantity + 1})" ${item.quantity >= 99 ? 'disabled' : ''}>+</button>
                                    </div>
                                    <button class="remove-item-btn" onclick="removeItem(${item.productId}, ${item.platformId ?? 'null'}, '${item.name.replace(/"/g, '&quot;')}')">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                            <path d="M10 11v6"></path>
                                            <path d="M14 11v6"></path>
                                            <path d="M9 6V4a2 2 0 0 1 2-2h2a 2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                        X√≥a
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                // G√°n s·ª± ki·ªán cho checkbox item
                document.querySelectorAll('.item-select').forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        const k = e.target.getAttribute('data-key');
                        if (e.target.checked) selectedKeys.add(k); else selectedKeys.delete(k);
                        const removeSelectedBtn = document.getElementById('removeSelectedBtn');
                        if (removeSelectedBtn) removeSelectedBtn.disabled = selectedKeys.size === 0;
                        const selectAllEl = document.getElementById('selectAll');
                        if (selectAllEl) {
                            const total = document.querySelectorAll('.item-select').length;
                            const checked = document.querySelectorAll('.item-select:checked').length;
                            selectAllEl.checked = total > 0 && total === checked;
                            selectAllEl.indeterminate = checked > 0 && checked < total;
                        }
                    });
                });
            }

            const summary = cartState.summary || { subtotal: 0, discount: 0, total: 0, itemCount: 0 };
            document.getElementById('subtotal').textContent = formatCurrency(summary.subtotal);
            document.getElementById('discount').textContent = summary.discount > 0 ? `-${formatCurrency(summary.discount)}` : '0‚Ç´';
            document.getElementById('saving').textContent = summary.discount > 0 ? `-${formatCurrency(summary.discount)}` : '0‚Ç´';
            document.getElementById('shipping').textContent = 'Mi·ªÖn ph√≠';
            document.getElementById('total').textContent = formatCurrency(summary.total);
            document.getElementById('m-subtotal')?.replaceChildren(document.createTextNode(formatCurrency(summary.subtotal)));
            document.getElementById('m-discount')?.replaceChildren(document.createTextNode(summary.discount > 0 ? `-${formatCurrency(summary.discount)}` : '0‚Ç´'));
            document.getElementById('m-shipping')?.replaceChildren(document.createTextNode('Mi·ªÖn ph√≠'));
            document.getElementById('m-total')?.replaceChildren(document.createTextNode(formatCurrency(summary.total)));

            // B·∫≠t/t·∫Øt n√∫t thanh to√°n theo s·ªë l∆∞·ª£ng item
            const checkoutBtn = document.getElementById('checkoutBtn');
            if (checkoutBtn) checkoutBtn.disabled = items.length === 0;
            const mCheckoutBtn = document.getElementById('m-checkoutBtn');
            if (mCheckoutBtn) mCheckoutBtn.disabled = items.length === 0;

            // ƒê·ªìng b·ªô ch·ªçn t·∫•t c·∫£ v√† n√∫t x√≥a ƒë√£ ch·ªçn
            const validKeys = new Set(items.map(getKey));
            for (const k of Array.from(selectedKeys)) { if (!validKeys.has(k)) selectedKeys.delete(k); }
            const removeSelectedBtn = document.getElementById('removeSelectedBtn');
            if (removeSelectedBtn) removeSelectedBtn.disabled = selectedKeys.size === 0;
            const selectAllEl = document.getElementById('selectAll');
            if (selectAllEl) {
                selectAllEl.checked = items.length > 0 && selectedKeys.size === items.length;
                selectAllEl.indeterminate = selectedKeys.size > 0 && selectedKeys.size < items.length;
            }
        }

        // S·ª± ki·ªán click thanh to√°n (placeholder)
        document.getElementById('checkoutBtn')?.addEventListener('click', () => {
            alert('Ch·ª©c nƒÉng thanh to√°n ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
        });

        // L·∫Øng nghe s·ª± ki·ªán c·∫≠p nh·∫≠t t·ª´ cart client
        window.addEventListener('cart:ready', () => renderCart());
        window.addEventListener('cart:updated', (e) => renderCart(e.detail));

        document.addEventListener('DOMContentLoaded', () => {
            renderCart();
            const selectAll = document.getElementById('selectAll');
            selectAll?.addEventListener('change', () => {
                const items = window.cartClient?.items || [];
                if (selectAll.checked) {
                    selectedKeys.clear();
                    items.forEach(it => selectedKeys.add(getKey(it)));
                } else {
                    selectedKeys.clear();
                }
                renderCart();
            });
            document.getElementById('removeSelectedBtn')?.addEventListener('click', async () => {
                const items = window.cartClient?.items || [];
                for (const it of items) {
                    const key = getKey(it);
                    if (selectedKeys.has(key)) {
                        await window.cartClient.removeItem(it.productId, it.platformId);
                    }
                }
                selectedKeys.clear();
            });
        });

        // X√°c nh·∫≠n x√≥a s·∫£n ph·∫©m
        document.getElementById('confirmRemoveBtn')?.addEventListener('click', async () => {
            if (!pendingRemove) return;
            try {
                await window.cartClient.removeItem(pendingRemove.productId, pendingRemove.platformId);
            } finally {
                const modalEl = document.getElementById('removeConfirmModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal?.hide();
                pendingRemove = null;
            }
        });

        // ·∫®n n√∫t "C·∫≠p nh·∫≠t gi·ªè h√†ng" sau khi render l·∫°i
        document.getElementById('updateCartBtn')?.addEventListener('click', () => {
            renderCart();
            document.getElementById('updateCartBtn')?.classList.add('d-none');
        });
    </script>
}