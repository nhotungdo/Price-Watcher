@page "/search/results"
@model PriceWatcher.Pages.SearchModel
@using System.Text.Json
@{
    ViewData["Title"] = "T√¨m ki·∫øm s·∫£n ph·∫©m";
}

<div class="search-page container-fluid px-3 py-4">
    <div class="card shadow-sm mb-3 search-hero">
        <div class="card-body">
            <form id="searchForm" class="search-form row g-2 align-items-center" autocomplete="off">
                <div class="col-12 col-md">
                    <label for="searchInput" class="form-label fw-semibold text-muted small mb-1">Nh·∫≠p t·ª´ kh√≥a ho·∫∑c d√°n URL s·∫£n ph·∫©m</label>
                    <input type="text"
                           class="form-control form-control-lg"
                           id="searchInput"
                           name="q"
                           value="@Model.Query"
                           placeholder="V√≠ d·ª•: iPhone 15 Pro Max ho·∫∑c https://..." />
                </div>
                <div class="col-12 col-md-auto">
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <span class="me-1">T√¨m ki·∫øm</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </button>
                </div>
            </form>
            <div class="search-mode-hint mt-2 text-muted small">
                @if (string.Equals(Model.Response.SearchMode, "url", StringComparison.OrdinalIgnoreCase))
                {
                    <span>üîó ƒêang t√¨m theo URL s·∫£n ph·∫©m</span>
                }
                else
                {
                    <span>üîç ƒêang t√¨m theo t·ª´ kh√≥a</span>
                }
            </div>
        </div>
    </div>

    
    <div id="searchAlerts">
        @foreach (var notice in Model.Response.Notices)
        {
            var alertClass = notice.Type switch
            {
                "error" => "alert-danger",
                "warning" => "alert-warning",
                "info" => "alert-info",
                "success" => "alert-success",
                _ => "alert-secondary"
            };
            <div class="alert @alertClass d-flex align-items-center" role="alert">
                <span class="me-2">‚ÑπÔ∏è</span>
                <span>@notice.Message</span>
            </div>
        }
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2 search-meta">
        <div>
            <strong>@Model.Response.TotalItems</strong> k·∫øt qu·∫£
            @if (Model.Response.DurationMs > 0)
            {
                <span class="text-muted ms-2">(~@Model.Response.DurationMs ms)</span>
            }
        </div>
        <div class="d-flex gap-2 align-items-center">
            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="4" y1="21" x2="4" y2="14"></line>
                    <line x1="4" y1="10" x2="4" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12" y2="3"></line>
                    <line x1="20" y1="21" x2="20" y2="16"></line>
                    <line x1="20" y1="12" x2="20" y2="3"></line>
                    <line x1="1" y1="14" x2="7" y2="14"></line>
                    <line x1="9" y1="8" x2="15" y2="8"></line>
                    <line x1="17" y1="16" x2="23" y2="16"></line>
                </svg>
                L·ªçc
            </button>
            <select class="form-select form-select-sm" id="sortSelect" style="width: auto;">
                <option value="">S·∫Øp x·∫øp</option>
                <option value="price_asc">Gi√° tƒÉng d·∫ßn</option>
                <option value="price_desc">Gi√° gi·∫£m d·∫ßn</option>
                <option value="discount">Khuy·∫øn m√£i</option>
                <option value="rating">ƒê√°nh gi√° cao</option>
                <option value="popular">B√°n ch·∫°y</option>
            </select>
            <span class="text-muted small">
                Trang @Model.Response.Page / @Math.Max(1, (int)Math.Ceiling(Math.Max(1, Model.Response.TotalItems) / (double)Math.Max(1, Model.Response.PageSize)))
            </span>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="collapse mb-3" id="filterPanel">
        <div class="card card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-semibold small">N·ªÅn t·∫£ng</label>
                    <div class="form-check">
                        <input class="form-check-input filter-platform" type="checkbox" value="tiki" id="filterTiki">
                        <label class="form-check-label" for="filterTiki">Tiki</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input filter-platform" type="checkbox" value="shopee" id="filterShopee">
                        <label class="form-check-label" for="filterShopee">Shopee</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input filter-platform" type="checkbox" value="lazada" id="filterLazada">
                        <label class="form-check-label" for="filterLazada">Lazada</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold small">Kho·∫£ng gi√°</label>
                    <div class="input-group input-group-sm mb-2">
                        <input type="number" class="form-control" id="priceMin" placeholder="T·ª´">
                        <span class="input-group-text">‚Ç´</span>
                    </div>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="priceMax" placeholder="ƒê·∫øn">
                        <span class="input-group-text">‚Ç´</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold small">ƒê√°nh gi√°</label>
                    <div class="form-check">
                        <input class="form-check-input filter-rating" type="radio" name="rating" value="5" id="rating5">
                        <label class="form-check-label" for="rating5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input filter-rating" type="radio" name="rating" value="4" id="rating4">
                        <label class="form-check-label" for="rating4">‚≠ê‚≠ê‚≠ê‚≠ê tr·ªü l√™n</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input filter-rating" type="radio" name="rating" value="3" id="rating3">
                        <label class="form-check-label" for="rating3">‚≠ê‚≠ê‚≠ê tr·ªü l√™n</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold small">Kh√°c</label>
                    <div class="form-check">
                        <input class="form-check-input filter-option" type="checkbox" value="discount" id="filterDiscount">
                        <label class="form-check-label" for="filterDiscount">C√≥ gi·∫£m gi√°</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input filter-option" type="checkbox" value="freeship" id="filterFreeship">
                        <label class="form-check-label" for="filterFreeship">Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</label>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-primary btn-sm" id="applyFilters">√Åp d·ª•ng</button>
                <button class="btn btn-outline-secondary btn-sm" id="clearFilters">X√≥a b·ªô l·ªçc</button>
            </div>
        </div>
    </div>

    @if (Model.Response.Suggestions.Any())
    {
        <div class="search-suggestions mb-3">
            <span class="text-muted small me-2">G·ª£i √Ω:</span>
            @foreach (var suggestion in Model.Response.Suggestions)
            {
                <button type="button" class="btn btn-outline-secondary btn-sm search-suggestion" data-value="@suggestion">@suggestion</button>
            }
        </div>
    }

    <div id="searchResultGrid" class="row g-3">
        @if (Model.Response.Items.Count == 0)
        {
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <p class="mb-0">Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o ph√π h·ª£p. Th·ª≠ t·ª´ kh√≥a kh√°c nh√©!</p>
                    </div>
                </div>
            </div>
        }
        else
        {
            foreach (var item in Model.Response.Items)
            {
                <div class="col-12 col-md-6 col-lg-4 col-xl-3">
                    <div class="search-card h-100">
                        <div class="search-card__media">
                            <img src="@(!string.IsNullOrWhiteSpace(item.ImageUrl) ? item.ImageUrl : "/images/placeholder.png")" alt="@item.Title" loading="lazy" />
                            @if (item.IsExactMatch)
                            {
                                <span class="badge bg-success position-absolute top-0 start-0 m-2">Kh·ªõp ch√≠nh x√°c</span>
                            }
                        </div>
                        <div class="search-card__body">
                            <div class="search-card__platform text-uppercase small text-muted">@item.Platform</div>
                            <h3 class="search-card__title">@Html.Raw(string.IsNullOrWhiteSpace(item.HighlightedTitle) ? item.Title : item.HighlightedTitle)</h3>
                            <div class="search-card__price">
                                @if (item.Price.HasValue)
                                {
                                    <span>@item.Price.Value.ToString("N0") ‚Ç´</span>
                                }
                                else
                                {
                                    <span class="text-muted">Li√™n h·ªá shop</span>
                                }
                            </div>
                            @if (item.Rating.HasValue)
                            {
                                <div class="search-card__rating text-muted small">
                                    ‚≠ê @item.Rating.Value.ToString("0.0") | @item.ReviewCount?.ToString("N0") ƒë√°nh gi√°
                                </div>
                            }
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="badge bg-light text-dark">Score @item.MatchScore.ToString("P0")</span>
                                @if (!string.IsNullOrWhiteSpace(item.ProductUrl))
                                {
                                    <a class="buy-btn buy-btn--sm" href="@item.ProductUrl" target="_blank" rel="noopener">T·ªõi n∆°i b√°n</a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    @if (Model.Response.TotalItems > Model.Response.PageSize)
    {
        <nav class="mt-4 d-flex justify-content-center">
            <ul class="pagination">
                @{
                    var prevDisabled = Model.Response.Page <= 1 ? "disabled" : string.Empty;
                    var nextDisabled = Model.Response.Page >= Math.Ceiling((double)Model.Response.TotalItems / Model.Response.PageSize) ? "disabled" : string.Empty;
                    var nextPage = Math.Min((int)Math.Ceiling((double)Model.Response.TotalItems / Model.Response.PageSize), Model.Response.Page + 1);
                }
                <li class="page-item @prevDisabled">
                    <button class="page-link" data-page="@Math.Max(1, Model.Response.Page - 1)">Tr∆∞·ªõc</button>
                </li>
                <li class="page-item @nextDisabled">
                    <button class="page-link" data-page="@nextPage">Sau</button>
                </li>
            </ul>
        </nav>
    }
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/search.css" asp-append-version="true" />
}

@section Scripts {
    <script>
        window.__initialSearchState = @Html.Raw(JsonSerializer.Serialize(new {
            query = Model.Query ?? string.Empty,
            page = Model.Response.Page,
            total = Model.Response.TotalItems,
            pageSize = Model.Response.PageSize
        }));
    </script>
    <script src="~/js/search.js" asp-append-version="true"></script>
}
