@page
@model PriceWatcher.Pages.IndexModel
@{
    ViewData["Title"] = "AI Price Advisor";
}

<div class="home-container" role="main">
    <div class="home-content container">
        <h1 class="main-title">
            <span class="title-ai">AI</span>
            <span class="title-price-advisor">Price Advisor</span>
        </h1>
        <p class="subtitle">Nhận định giá sản phẩm hợp lý bằng trí tuệ nhân tạo</p>

        <div class="form-card">
            <form id="priceAnalysisForm" method="post" novalidate aria-label="Price analysis form">
                <div class="form-group">
                    <label for="productLink" class="form-label">Link sản phẩm (Tùy chọn)</label>
                    <input type="url" class="form-control" id="productLink" name="productLink"
                        placeholder="https://example.com/product-link" aria-label="Product link" />
                </div>

                <div class="form-group">
                    <label for="productImage" class="form-label">Hình ảnh sản phẩm (Tùy chọn)</label>
                    <div class="image-upload-area" id="imageUploadArea">
                        <input type="file" id="productImage" name="productImage"
                            accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" capture="environment" style="display: none;"
                            aria-label="Product image" />
                        <div class="upload-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            <span class="plus-icon">+</span>
                        </div>
                        <p class="upload-text">Tải ảnh lên hoặc kéo thả</p>
                        <p class="upload-hint">PNG, JPG, GIF, WEBP lên tới 5MB</p>
                        <div id="imagePreview" class="image-preview" style="display: none;">
                            <img id="previewImg" src="" alt="Preview" />
                            <button type="button" class="remove-image" id="removeImage">×</button>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-analyze" aria-label="Analyze price">Phân tích giá</button>
            </form>
            <div id="analysisResults" class="analysis-results" style="margin-top: 20px;"></div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="row" style="gap:12px;">
        <div class="col-12">
            <div style="font-size:20px;font-weight:700;margin-bottom:8px;">Các sàn hỗ trợ</div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card" style="border:1px solid #eee;border-radius:12px;overflow:hidden;">
                <div class="card-body" style="display:flex;align-items:center;gap:12px;">
                    <div aria-hidden="true" style="width:40px;height:40px;border-radius:8px;background:#ff5a00;display:flex;align-items:center;justify-content:center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Shopee logo">
                            <path d="M16 7.5C16 9.43 14.43 11 12.5 11C10.57 11 9 9.43 9 7.5" stroke="white" stroke-width="1.6" stroke-linecap="round"/>
                            <rect x="5" y="8" width="14" height="10" rx="3" fill="white" opacity="0.15"/>
                            <path d="M7 9.5H17V16.5C17 17.33 16.33 18 15.5 18H8.5C7.67 18 7 17.33 7 16.5V9.5Z" fill="white"/>
                        </svg>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;">Shopee</div>
                        <div style="color:#666;">Sàn TMĐT phổ biến với nhiều ưu đãi, đa dạng sản phẩm.</div>
                    </div>
                    <a href="https://shopee.vn" target="_blank" rel="noopener" class="btn btn-outline-secondary btn-sm">Trang chủ</a>
                </div>
            </div>
        </div>


        <div class="col-12 col-md-6">
            <div class="card" style="border:1px solid #eee;border-radius:12px;overflow:hidden;">
                <div class="card-body" style="display:flex;align-items:center;gap:12px;">
                    <div aria-hidden="true" style="width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#1a75ff,#ff4b8b);display:flex;align-items:center;justify-content:center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Lazada logo">
                            <path d="M12 6L16.5 8.6V13.8L12 16.4L7.5 13.8V8.6L12 6Z" fill="white"/>
                        </svg>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;">Lazada</div>
                        <div style="color:#666;">Sàn TMĐT với nhiều shop chính hãng, giao hàng nhanh.</div>
                    </div>
                    <a href="https://www.lazada.vn" target="_blank" rel="noopener" class="btn btn-outline-secondary btn-sm">Trang chủ</a>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card" style="border:1px solid #eee;border-radius:12px;overflow:hidden;">
                <div class="card-body" style="display:flex;align-items:center;gap:12px;">
                    <div aria-hidden="true" style="width:40px;height:40px;border-radius:8px;background:#0ABDE3;display:flex;align-items:center;justify-content:center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Tiki logo">
                            <circle cx="8" cy="10" r="2" fill="white"/>
                            <circle cx="16" cy="10" r="2" fill="white"/>
                            <rect x="6" y="14" width="12" height="2" rx="1" fill="white"/>
                        </svg>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;">Tiki</div>
                        <div style="color:#666;">Sàn TMĐT uy tín với nhiều gian hàng chính hãng.</div>
                    </div>
                    <a href="https://tiki.vn" target="_blank" rel="noopener" class="btn btn-outline-secondary btn-sm">Trang chủ</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Image upload handling
        const imageUploadArea = document.getElementById('imageUploadArea');
        const productImageInput = document.getElementById('productImage');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeImageBtn = document.getElementById('removeImage');

        // Click to upload
        imageUploadArea.addEventListener('click', () => {
            productImageInput.click();
        });

        // Drag and drop
        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.classList.add('drag-over');
        });

        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('drag-over');
        });

        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageFile(files[0]);
            }
        });

        // File input change
        productImageInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageFile(e.target.files[0]);
            }
        });

        function supportsWebP() {
            try {
                const canvas = document.createElement('canvas');
                return canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0;
            } catch { return false; }
        }

        function handleImageFile(file) {
            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Vui lòng chọn file ảnh hợp lệ (PNG, JPG, GIF, WEBP)');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('Kích thước file không được vượt quá 5MB');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                if (file.type === 'image/webp' && !supportsWebP()) {
                    imagePreview.style.display = 'none';
                    previewImg.src = '';
                    alert('Trình duyệt không hỗ trợ xem trước ảnh WebP. Ảnh vẫn sẽ được gửi để phân tích.');
                } else {
                    previewImg.src = dataUrl;
                    imagePreview.style.display = 'block';
                    imageUploadArea.querySelector('.upload-icon').style.display = 'none';
                    imageUploadArea.querySelector('.upload-text').style.display = 'none';
                    imageUploadArea.querySelector('.upload-hint').style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        }

        // Remove image
        removeImageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            productImageInput.value = '';
            imagePreview.style.display = 'none';
            previewImg.src = '';
            imageUploadArea.querySelector('.upload-icon').style.display = 'flex';
            imageUploadArea.querySelector('.upload-text').style.display = 'block';
            imageUploadArea.querySelector('.upload-hint').style.display = 'block';
        });

        function isSupportedProductUrl(url) {
            try {
                const u = new URL(url);
                const h = u.hostname.toLowerCase();
                return h.includes('shopee') || h.includes('lazada') || h.includes('tiki');
            } catch {
                return false;
            }
        }

        document.getElementById('priceAnalysisForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const link = document.getElementById('productLink').value.trim();
            const fileInput = document.getElementById('productImage');
            const uid = parseInt(document.body.getAttribute('data-uid') || '0', 10);
            const formData = new FormData();
            formData.append('userId', String(uid));
            const resultsEl = document.getElementById('analysisResults');
            if (link) {
                if (!isSupportedProductUrl(link)) {
                    resultsEl.textContent = 'URL sản phẩm không hợp lệ hoặc không thuộc nền tảng hỗ trợ.';
                    return;
                }
                formData.append('url', link);
            }
            if (fileInput.files && fileInput.files.length > 0) {
                formData.append('image', fileInput.files[0]);
            }
            let searchId;
            try {
                const res = await fetch('/search/submit', { method: 'POST', body: formData });
                if (!res.ok) {
                    const txt = await res.text();
                    resultsEl.textContent = txt || 'Gửi yêu cầu phân tích thất bại';
                    return;
                }
                ({ searchId } = await res.json());
            } catch (err) {
                resultsEl.textContent = 'Không thể kết nối tới máy chủ. Vui lòng kiểm tra server đang chạy tại http://localhost:5000.';
                return;
            }
            resultsEl.innerHTML = 'Đang phân tích...';
            let status = null;
            for (let i = 0; i < 30; i++) {
                const sres = await fetch(`/search/status/${searchId}`);
                if (sres.ok) {
                    status = await sres.json();
                    if (status.status === 'Completed' || status.status === 'Failed') break;
                }
                await new Promise(r => setTimeout(r, 1000));
            }
            if (!status) {
                resultsEl.textContent = 'Không nhận được kết quả, vui lòng thử lại.';
                return;
            }
            if (status.status === 'Failed') {
                resultsEl.textContent = status.message || 'Phân tích thất bại.';
                return;
            }
            const items = status.results || [];
            if (items.length === 0) {
                resultsEl.textContent = 'Không tìm thấy đề xuất phù hợp.';
                return;
            }

            const renderList = (title, list) => {
                const block = document.createElement('div');
                block.innerHTML = `<div style="font-weight:600;margin:12px 0 6px;">${title}</div>`;
                for (const it of list) {
                    const labels = (it.labels || []).join(', ');
                    const total = (it.totalCost || 0).toLocaleString('vi-VN');
                    const price = (it.price || 0).toLocaleString('vi-VN');
                    const ship = (it.shippingCost || 0).toLocaleString('vi-VN');
                    const row = document.createElement('div');
                    row.className = 'result-item';
                    row.style = 'display:flex;align-items:center;gap:12px;padding:12px;border:1px solid #eee;border-radius:8px;margin-bottom:12px;';
                    row.innerHTML = `
                        <img src="${it.thumbnailUrl}" alt="thumb" style="width:64px;height:64px;object-fit:cover;border-radius:6px;"/>
                        <div style="flex:1;">
                            <div style="font-weight:600;">${it.title}</div>
                            <div style="color:#666;">${it.platform} • ${it.shopName} • ⭐ ${it.shopRating?.toFixed ? it.shopRating.toFixed(2) : it.shopRating}</div>
                            <div style="margin-top:4px;">Giá: ${price}₫${it.originalPrice ? ' • Giá gốc: ' + Number(it.originalPrice).toLocaleString('vi-VN') + '₫' : ''}${typeof it.discountPercent === 'number' ? ' • KM: ' + Math.round(it.discountPercent * 100) + '%': ''} • Ship: ${ship}₫ • Tổng: <strong>${total}₫</strong></div>
                            ${typeof it.soldCount === 'number' ? `<div style="margin-top:4px;">Đã bán: ${it.soldCount}</div>` : ''}
                            ${it.sellerType ? `<div style="margin-top:4px;">Người bán: ${it.sellerType}</div>` : ''}
                            ${typeof it.matchScore === 'number' ? `<div style="margin-top:4px;">Phù hợp: <strong>${Math.round(it.matchScore * 100)}%</strong>${it.fitReason ? ' • ' + it.fitReason : ''}</div>` : ''}
                            ${labels ? `<div style="margin-top:4px;color:#0a7;">${labels}</div>` : ''}
                        </div>
                        <a href="${it.productUrl}" target="_blank" rel="noopener" class="btn btn-sm btn-primary">Mở</a>`;
                    block.appendChild(row);
                }
                resultsEl.appendChild(block);
            };

            const renderComparisonTable = (platform, list) => {
                const table = document.createElement('table');
                table.style = 'width:100%;border-collapse:collapse;margin:12px 0;';
                table.innerHTML = `
                    <thead>
                        <tr style="text-align:left">
                            <th style="padding:8px;border-bottom:1px solid #ddd;">Sản phẩm</th>
                            <th style="padding:8px;border-bottom:1px solid #ddd;">Giá</th>
                            <th style="padding:8px;border-bottom:1px solid #ddd;">Giá gốc</th>
                            <th style="padding:8px;border-bottom:1px solid #ddd;">KM</th>
                            <th style="padding:8px;border-bottom:1px solid #ddd;">⭐ Đánh giá</th>
                            <th style="padding:8px;border-bottom:1px solid #ddd;">Đã bán</th>
                            <th style="padding:8px;border-bottom:1px solid #ddd;">Người bán</th>
                            <th style="padding:8px;border-bottom:1px solid #ddd;">Link</th>
                        </tr>
                    </thead>
                    <tbody></tbody>`;
                const body = table.querySelector('tbody');
                for (const it of list.slice(0, 12)) {
                    const tr = document.createElement('tr');
                    const price = (it.price || 0).toLocaleString('vi-VN');
                    const orig = it.originalPrice ? Number(it.originalPrice).toLocaleString('vi-VN') : '';
                    const km = typeof it.discountPercent === 'number' ? Math.round(it.discountPercent * 100) + '%' : '';
                    tr.innerHTML = `
                        <td style="padding:8px;border-bottom:1px solid #eee;">${it.title}</td>
                        <td style="padding:8px;border-bottom:1px solid #eee;">${price}₫</td>
                        <td style="padding:8px;border-bottom:1px solid #eee;">${orig}${orig ? '₫' : ''}</td>
                        <td style="padding:8px;border-bottom:1px solid #eee;">${km}</td>
                        <td style="padding:8px;border-bottom:1px solid #eee;">${it.shopRating ?? ''}</td>
                        <td style="padding:8px;border-bottom:1px solid #eee;">${it.soldCount ?? ''}</td>
                        <td style="padding:8px;border-bottom:1px solid #eee;">${it.sellerType ?? (it.shopName || '')}</td>
                        <td style="padding:8px;border-bottom:1px solid #eee;"><a href="${it.productUrl}" target="_blank" rel="noopener">Mở</a></td>`;
                    body.appendChild(tr);
                }
                const wrap = document.createElement('div');
                wrap.innerHTML = `<div style="font-weight:600;margin:12px 0 6px;">Bảng so sánh trên ${platform}</div>`;
                wrap.appendChild(table);
                resultsEl.appendChild(wrap);
            };

            if (status.originalPrice) {
                const head = document.createElement('div');
                head.style = 'padding:12px;border:1px dashed #ccc;border-radius:8px;margin-bottom:12px;';
                const base = (status.originalPrice || 0).toLocaleString('vi-VN');
                head.innerHTML = `<div style="font-weight:600;margin-bottom:6px;">Giá gốc ước tính</div><div><strong>${base}₫</strong>${status.productName ? ' • ' + status.productName : ''}${status.category ? ' • ' + status.category : ''}</div>`;
                if (status.productImageUrl) {
                    const img = document.createElement('img');
                    img.src = status.productImageUrl;
                    img.style = 'width:64px;height:64px;object-fit:cover;border-radius:6px;margin-top:6px;';
                    head.appendChild(img);
                }
                resultsEl.appendChild(head);
                renderList('Nhóm giá thấp hơn', status.lower || []);
                renderList('Nhóm giá cao hơn', status.higher || []);
            } else {
                const byPlatform = {};
                for (const it of items) {
                    const k = it.platform;
                    if (!byPlatform[k] || byPlatform[k].totalCost > it.totalCost) byPlatform[k] = it;
                }
                const summary = Object.keys(byPlatform).map(p => {
                    const it = byPlatform[p];
                    const total = (it.totalCost || 0).toLocaleString('vi-VN');
                    return `<div>• ${p}: <strong>${total}₫</strong> — <a href="${it.productUrl}" target="_blank" rel="noopener">Mở</a></div>`;
                }).join('');
                const box = document.createElement('div');
                box.style = 'padding:12px;border:1px dashed #ccc;border-radius:8px;margin-bottom:12px;';
                box.innerHTML = `<div style="font-weight:600;margin-bottom:6px;">Giá tốt nhất theo từng sàn</div>${summary || 'Không có dữ liệu theo sàn'}`;
                resultsEl.appendChild(box);
                const groups = items.reduce((acc, it) => { (acc[it.platform] ||= []).push(it); return acc; }, {});
                for (const p of Object.keys(groups)) {
                    renderComparisonTable(p, groups[p]);
                    renderList(`Kết quả trên ${p}`, groups[p]);
                }
                renderList('Toàn bộ kết quả', items);
            }
        });
    </script>
}