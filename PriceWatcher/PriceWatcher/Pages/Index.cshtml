@page
@model IndexModel
@{
    ViewData["Title"] = "SƒÉn Sale T·ªët - So s√°nh gi√° t·ªët nh·∫•t";
}

<div class="tiki-homepage">
    <div class="container-fluid px-3">
        <div class="row g-3">
            <!-- Left Sidebar - Categories -->
            <div class="col-lg-2 d-none d-lg-block">
                <aside class="sidebar-categories">
                    <div class="category-menu">
                        <h6 class="category-menu-title">Danh M·ª•c</h6>
                        <ul class="category-list">
                            <li class="category-item">
                                <a href="/category/electronics" class="category-link">
                                    <i class="category-icon">üì±</i>
                                    <span>ƒêi·ªán Tho·∫°i - MTB</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/laptop" class="category-link">
                                    <i class="category-icon">üíª</i>
                                    <span>Laptop - IT</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/camera" class="category-link">
                                    <i class="category-icon">üì∑</i>
                                    <span>M√°y ·∫¢nh</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/audio" class="category-link">
                                    <i class="category-icon">üéß</i>
                                    <span>√Çm Thanh</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/watch" class="category-link">
                                    <i class="category-icon">‚åö</i>
                                    <span>ƒê·ªìng H·ªì</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/home" class="category-link">
                                    <i class="category-icon">üè†</i>
                                    <span>Nh√† C·ª≠a</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/books" class="category-link">
                                    <i class="category-icon">üìö</i>
                                    <span>S√°ch</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/fashion" class="category-link">
                                    <i class="category-icon">üëï</i>
                                    <span>Th·ªùi Trang</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </aside>
            </div>

            <!-- Main Content Area -->
            <div class="col-lg-10">
                <!-- Hero Carousel -->
                <section class="hero-section mb-3">
                    <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-indicators">
                            <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                            <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                            <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                        </div>
                        <div class="carousel-inner">
                            <div class="carousel-item active">
                                <img src="https://salt.tikicdn.com/cache/w1080/ts/tikimsp/f9/26/5d/42491106824968c9276435c25603893c.png" class="d-block w-100" alt="Khuy·∫øn m√£i l·ªõn" loading="eager">
                            </div>
                            <div class="carousel-item">
                                <img src="https://salt.tikicdn.com/cache/w1080/ts/tikimsp/57/5a/2f/575a2f89106824968c9276435c25603893c.png" class="d-block w-100" alt="Gi·∫£m gi√° s·ªëc" loading="lazy">
                            </div>
                            <div class="carousel-item">
                                <img src="https://salt.tikicdn.com/cache/w1080/ts/tikimsp/89/10/68/24968c9276435c25603893c.png" class="d-block w-100" alt="∆Øu ƒë√£i ƒë·∫∑c bi·ªát" loading="lazy">
                            </div>
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                </section>

                <!-- Crawl Input Section -->
                <section class="crawl-section mb-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Theo d√µi gi√° s·∫£n ph·∫©m Tiki</h5>
                            <div class="input-group mb-3">
                                <input type="text" id="crawlUrlInput" class="form-control" placeholder="D√°n link s·∫£n ph·∫©m Tiki v√†o ƒë√¢y (v√≠ d·ª•: https://tiki.vn/iphone-15-p271966088.html)" aria-label="Tiki URL">
                                <button class="btn btn-primary" type="button" id="btnCrawl">
                                    <span id="crawlSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    Theo d√µi ngay
                                </button>
                            </div>
                            <div id="crawlResult" class="d-none">
                                <div class="alert alert-success d-flex align-items-center" role="alert">
                                    <img id="previewImage" src="" alt="Preview" class="me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                    <div>
                                        <h6 id="previewTitle" class="mb-0"></h6>
                                        <div class="small">
                                            <span id="previewPrice" class="fw-bold text-danger"></span>
                                            <span id="previewMessage" class="text-muted ms-2"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="crawlError" class="alert alert-danger d-none" role="alert"></div>
                        </div>
                    </div>
                </section>

                <!-- Flash Deal Section -->
                <section class="flash-deal-section-wrapper mb-3">
                    <div class="flash-deal-section">
                        <div class="flash-deal-header">
                            <h2 class="flash-deal-title">
                                <span class="flash-icon">‚ö°</span>
                                Flash Sale H√¥m Nay
                            </h2>
                            <div class="countdown-timer">
                                <span class="countdown-label">K·∫øt th√∫c sau:</span>
                                <div class="countdown-item">
                                    <span class="countdown-value" id="hours">02</span>
                                    <span class="countdown-unit">Gi·ªù</span>
                                </div>
                                <div class="countdown-item">
                                    <span class="countdown-value" id="minutes">30</span>
                                    <span class="countdown-unit">Ph√∫t</span>
                                </div>
                                <div class="countdown-item">
                                    <span class="countdown-value" id="seconds">45</span>
                                    <span class="countdown-unit">Gi√¢y</span>
                                </div>
                            </div>
                        </div>
                        <div class="deal-products">
                            <!-- Deal products will be loaded here -->
                        </div>
                    </div>
                </section>

                <!-- Product Showcase -->
                <section class="product-showcase">
                    <div class="section-header">
                        <h2 class="section-title">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            G·ª£i √ù H√¥m Nay
                        </h2>
                        <a href="/products" class="view-all-link">
                            Xem t·∫•t c·∫£
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </a>
                    </div>

                    <div class="row g-3" id="featuredProductsContainer">
                        <!-- Products will be loaded here via JS -->
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/cart.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadFeaturedProducts();

            const btnCrawl = document.getElementById('btnCrawl');
            const inputUrl = document.getElementById('crawlUrlInput');
            const crawlResult = document.getElementById('crawlResult');
            const crawlError = document.getElementById('crawlError');
            const spinner = document.getElementById('crawlSpinner');

            btnCrawl.addEventListener('click', async function() {
                const url = inputUrl.value.trim();
                
                if (!url) {
                    showError('Vui l√≤ng nh·∫≠p URL s·∫£n ph·∫©m Tiki');
                    return;
                }

                // Show loading
                spinner.classList.remove('d-none');
                btnCrawl.disabled = true;
                crawlResult.classList.add('d-none');
                crawlError.classList.add('d-none');

                try {
                    const response = await fetch('/api/crawl/tiki', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ url: url })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Show preview
                        document.getElementById('previewImage').src = data.imageUrl || '';
                        document.getElementById('previewTitle').textContent = data.name || '';
                        document.getElementById('previewPrice').textContent = formatPrice(data.price);
                        document.getElementById('previewMessage').textContent = data.message || 'ƒê√£ th√™m v√†o theo d√µi';
                        crawlResult.classList.remove('d-none');

                        // Reload products after a delay
                        setTimeout(() => loadFeaturedProducts(), 2000);
                    } else {
                        showError(data.message || 'Kh√¥ng th·ªÉ x·ª≠ l√Ω URL n√†y');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showError('ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu');
                } finally {
                    spinner.classList.add('d-none');
                    btnCrawl.disabled = false;
                }
            });

            function showError(message) {
                crawlError.textContent = message;
                crawlError.classList.remove('d-none');
                crawlResult.classList.add('d-none');
            }

            function formatPrice(price) {
                if (!price) return '';
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
            }
        });

        async function loadFeaturedProducts() {
            const container = document.getElementById('featuredProductsContainer');
            try {
                const response = await fetch('/api/home/featured?limit=12');
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const text = await response.text();
                const trimmed = text.trim();
                if (!trimmed || trimmed[0] === '<') throw new Error('Non-JSON response');
                const products = JSON.parse(trimmed);

                if (!Array.isArray(products) || products.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center text-muted">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o. H√£y th·ª≠ th√™m link Tiki ·ªü tr√™n!</div>';
                    return;
                }

                container.innerHTML = products.map(p => `
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="product-card" 
                             data-product-id="${p.productId}"
                             data-platform-id="${p.platformId || 1}"
                             data-platform-name="${p.platformName || 'Tiki'}"
                             data-product-name="${p.productName || ''}"
                             data-product-price="${p.currentPrice || 0}"
                             data-product-image="${p.imageUrl || ''}"
                             data-product-url="${p.originalUrl || ''}">
                            <div class="product-image-wrapper">
                                <img src="${p.imageUrl || '/images/placeholder.png'}" alt="${p.productName || ''}" class="product-image" loading="lazy">
                                ${p.discountRate ? `<span class="product-badge">-${p.discountRate}%</span>` : ''}
                            </div>
                            <div class="product-info">
                                <div class="product-name">${p.productName || ''}</div>
                                ${p.rating ? `
                                <div class="product-rating">
                                    <span class="rating-stars">${'‚≠ê'.repeat(Math.round(p.rating))}</span>
                                    <span class="rating-count">(${p.reviewCount || 0})</span>
                                </div>
                                ` : ''}
                                <div class="product-price-block">
                                    <span class="product-price">${formatPrice(p.currentPrice)}</span>
                                </div>
                                <button class="add-to-cart-btn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="9" cy="21" r="1"></circle>
                                        <circle cx="20" cy="21" r="1"></circle>
                                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                    </svg>
                                    Th√™m v√†o gi·ªè
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading products:', error);
                container.innerHTML = '<div class="col-12 text-center text-danger">Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m</div>';
            }
        }

        function formatPrice(price) {
            if (!price) return '0‚Ç´';
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
        }
    </script>
}