@page
@model PriceWatcher.Pages.IndexModel
@{
    ViewData["Title"] = "AI Price Watcher";
}

<div class="hero-section">
    <div class="container">
        <div class="row align-items-center justify-content-center">
            <div class="col-lg-10 text-center">
                <h1 class="hero-title">
                    <span class="text-gradient">AI Price Watcher</span>
                </h1>
                <p class="hero-subtitle">
                    Tìm kiếm, so sánh và theo dõi giá sản phẩm từ Shopee, Lazada, Tiki bằng trí tuệ nhân tạo.
                    <br class="d-none d-md-block" />
                    Mua sắm thông minh hơn, tiết kiệm hơn ngay hôm nay.
                </p>

                <div class="search-card">
                    <form id="priceAnalysisForm" method="post" novalidate aria-label="Price analysis form">
                        <div class="search-input-group">
                            <div class="input-wrapper">
                                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                                <input type="text" class="form-control search-input" id="productLink" name="productLink"
                                    placeholder="Dán link sản phẩm hoặc nhập tên sản phẩm (VD: iPhone 15)..." aria-label="Product link or name" />
                            </div>
                            <button type="button" class="btn-image-upload" id="btnToggleImage" title="Tìm bằng hình ảnh">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                            </button>
                            <button type="submit" class="btn-search">
                                <span>Phân tích ngay</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </button>
                        </div>

                        <div class="image-upload-area collapsed" id="imageUploadArea" style="display:none;">
                            <input type="file" id="productImage" name="productImage"
                                accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" style="display: none;" />
                            <div class="upload-content">
                                <div class="upload-icon-large">
                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                </div>
                                <div class="upload-text">
                                    <strong>Kéo thả ảnh vào đây</strong> hoặc click để tải lên
                                    <div class="small text-muted">Hỗ trợ PNG, JPG, WEBP (Max 5MB)</div>
                                </div>
                            </div>
                            <div id="imagePreview" class="image-preview" style="display: none;">
                                <img id="previewImg" src="" alt="Preview" />
                                <button type="button" class="remove-image" id="removeImage">×</button>
                            </div>
                        </div>
                    </form>
                    
                    <div id="analysisResults" class="analysis-results"></div>
                    <div id="exportShareBar" class="action-bar" style="display:none;">
                        <button type="button" id="btnExportPdf" class="btn btn-outline-light btn-sm">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> Xuất PDF
                        </button>
                        <button type="button" id="btnShare" class="btn btn-outline-light btn-sm">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg> Chia sẻ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="features-section">
    <div class="container">
        <div class="section-header text-center mb-5">
            <h2 class="section-title">Tại sao chọn PriceWatcher?</h2>
            <p class="section-desc">Công cụ hỗ trợ mua sắm trực tuyến thông minh nhất dành cho bạn</p>
        </div>
        
        <div class="row g-4">
            <div class="col-md-4">
                <div class="feature-card">
                    <div class="feature-icon bg-blue">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>
                    <h3>Tìm kiếm đa nền tảng</h3>
                    <p>Chỉ cần nhập tên sản phẩm, chúng tôi sẽ tìm kiếm trên Shopee, Lazada và Tiki cùng lúc.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="feature-card">
                    <div class="feature-icon bg-purple">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                    </div>
                    <h3>So sánh giá thông minh</h3>
                    <p>Tự động phân tích và đề xuất nơi bán có giá tốt nhất, uy tín nhất cho bạn.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="feature-card">
                    <div class="feature-icon bg-orange">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                        </svg>
                    </div>
                    <h3>Theo dõi lịch sử giá</h3>
                    <p>Biểu đồ biến động giá giúp bạn quyết định thời điểm mua hàng hợp lý nhất.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="platforms-section">
    <div class="container">
        <div class="text-center mb-4">
            <h2 class="section-title">Đối tác hỗ trợ</h2>
        </div>
        <div class="row justify-content-center g-4">
            <div class="col-6 col-md-3">
                <a href="https://shopee.vn" target="_blank" class="platform-card">
                    <div class="platform-logo shopee">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 7.5C16 9.43 14.43 11 12.5 11C10.57 11 9 9.43 9 7.5" stroke="white" stroke-width="1.6" stroke-linecap="round"/><rect x="5" y="8" width="14" height="10" rx="3" fill="white" opacity="0.2"/><path d="M7 9.5H17V16.5C17 17.33 16.33 18 15.5 18H8.5C7.67 18 7 17.33 7 16.5V9.5Z" fill="white"/></svg>
                    </div>
                    <span>Shopee</span>
                </a>
            </div>
            <div class="col-6 col-md-3">
                <a href="https://lazada.vn" target="_blank" class="platform-card">
                    <div class="platform-logo lazada">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 6L16.5 8.6V13.8L12 16.4L7.5 13.8V8.6L12 6Z" fill="white"/></svg>
                    </div>
                    <span>Lazada</span>
                </a>
            </div>
            <div class="col-6 col-md-3">
                <a href="https://tiki.vn" target="_blank" class="platform-card">
                    <div class="platform-logo tiki">
                        <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="8" cy="10" r="2" fill="white"/><circle cx="16" cy="10" r="2" fill="white"/><rect x="6" y="14" width="12" height="2" rx="1" fill="white"/></svg>
                    </div>
                    <span>Tiki</span>
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const imageUploadArea = document.getElementById('imageUploadArea');
        const productImageInput = document.getElementById('productImage');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeImageBtn = document.getElementById('removeImage');
        const btnToggleImage = document.getElementById('btnToggleImage');

        btnToggleImage.addEventListener('click', () => {
            if (imageUploadArea.style.display === 'none') {
                imageUploadArea.style.display = 'flex';
                imageUploadArea.classList.remove('collapsed');
            } else {
                imageUploadArea.style.display = 'none';
                imageUploadArea.classList.add('collapsed');
            }
        });

        imageUploadArea.addEventListener('click', (e) => {
            if (e.target !== removeImageBtn) productImageInput.click();
        });

        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.classList.add('drag-over');
        });

        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('drag-over');
        });

        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleImageFile(files[0]);
        });

        productImageInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleImageFile(e.target.files[0]);
        });

        function supportsWebP() {
            try {
                const canvas = document.createElement('canvas');
                return canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0;
            } catch { return false; }
        }

        function handleImageFile(file) {
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Vui lòng chọn file ảnh hợp lệ (PNG, JPG, GIF, WEBP)');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                alert('Kích thước file không được vượt quá 5MB');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                if (file.type === 'image/webp' && !supportsWebP()) {
                    imagePreview.style.display = 'none';
                    previewImg.src = '';
                    alert('Trình duyệt không hỗ trợ xem trước ảnh WebP.');
                } else {
                    previewImg.src = dataUrl;
                    imagePreview.style.display = 'block';
                    imageUploadArea.querySelector('.upload-content').style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        }

        removeImageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            productImageInput.value = '';
            imagePreview.style.display = 'none';
            previewImg.src = '';
            imageUploadArea.querySelector('.upload-content').style.display = 'block';
        });

        function isSupportedProductUrl(url) {
            try {
                const u = new URL(url);
                const h = u.hostname.toLowerCase();
                return h.includes('shopee') || h.includes('lazada') || h.includes('tiki');
            } catch { return false; }
        }

        document.getElementById('priceAnalysisForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const link = document.getElementById('productLink').value.trim();
            const fileInput = document.getElementById('productImage');
            const uid = parseInt(document.body.getAttribute('data-uid') || '0', 10);
            const formData = new FormData();
            formData.append('userId', String(uid));
            const resultsEl = document.getElementById('analysisResults');
            
            if (link) {
                if (link.startsWith('http://') || link.startsWith('https://')) {
                    if (!isSupportedProductUrl(link)) {
                        resultsEl.innerHTML = '<div class="alert alert-danger">URL sản phẩm không hợp lệ hoặc không thuộc nền tảng hỗ trợ (Shopee/Lazada/Tiki).</div>';
                        return;
                    }
                }
                formData.append('url', link);
            }
            if (fileInput.files && fileInput.files.length > 0) {
                formData.append('image', fileInput.files[0]);
            }

            if (!link && (!fileInput.files || fileInput.files.length === 0)) {
                 resultsEl.innerHTML = '<div class="alert alert-warning">Vui lòng nhập link, tên sản phẩm hoặc tải ảnh lên.</div>';
                 return;
            }

            let searchId;
            try {
                resultsEl.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">Đang phân tích...</div></div>';
                const res = await fetch('/search/submit', { method: 'POST', body: formData });
                if (!res.ok) {
                    const txt = await res.text();
                    resultsEl.innerHTML = `<div class="alert alert-danger">${txt || 'Gửi yêu cầu phân tích thất bại'}</div>`;
                    return;
                }
                ({ searchId } = await res.json());
            } catch (err) {
                resultsEl.innerHTML = '<div class="alert alert-danger">Không thể kết nối tới máy chủ.</div>';
                return;
            }

            let status = null;
            for (let i = 0; i < 30; i++) {
                const sres = await fetch(`/search/status/${searchId}`);
                if (sres.ok) {
                    status = await sres.json();
                    if (status.status === 'Completed' || status.status === 'Failed') break;
                }
                await new Promise(r => setTimeout(r, 1000));
            }

            if (!status) {
                resultsEl.innerHTML = '<div class="alert alert-warning">Không nhận được kết quả, vui lòng thử lại.</div>';
                return;
            }
            if (status.status === 'Failed') {
                resultsEl.innerHTML = `<div class="alert alert-danger">${status.message || 'Phân tích thất bại.'}</div>`;
                return;
            }

            const items = status.results || [];
            if (items.length === 0) {
                resultsEl.innerHTML = '<div class="alert alert-info">Không tìm thấy đề xuất phù hợp.</div>';
                return;
            }

            // Render results
            resultsEl.innerHTML = ''; // Clear loading
            
            const renderList = (title, list) => {
                if (!list || list.length === 0) return;
                const block = document.createElement('div');
                block.className = 'result-group';
                block.innerHTML = `<h3 class="result-group-title">${title}</h3>`;
                const grid = document.createElement('div');
                grid.className = 'result-grid';
                
                for (const it of list) {
                    const total = (it.totalCost || 0).toLocaleString('vi-VN');
                    const price = (it.price || 0).toLocaleString('vi-VN');
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `
                        <div class="product-thumb">
                            <img src="${it.thumbnailUrl}" alt="${it.title}" loading="lazy" />
                            <span class="platform-badge ${it.platform.toLowerCase()}">${it.platform}</span>
                            ${it.discountPercent ? `<span class="discount-badge">-${Math.round(it.discountPercent * 100)}%</span>` : ''}
                        </div>
                        <div class="product-info">
                            <h4 class="product-title" title="${it.title}">${it.title}</h4>
                            <div class="product-price">
                                <span class="current-price">${price}₫</span>
                                ${it.originalPrice ? `<span class="original-price">${Number(it.originalPrice).toLocaleString('vi-VN')}₫</span>` : ''}
                            </div>
                            <div class="product-meta">
                                <span>⭐ ${it.shopRating ? it.shopRating.toFixed(1) : 'N/A'}</span>
                                <span>• Đã bán ${it.soldCount || 0}</span>
                            </div>
                            <div class="product-actions">
                                <a href="${it.productUrl}" target="_blank" class="btn btn-primary btn-sm w-100">Xem ngay</a>
                                ${it.productId ? `<a href="/ProductDetail/${it.productId}" class="btn btn-outline-secondary btn-sm w-100 mt-1">Lịch sử giá</a>` : ''}
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                }
                block.appendChild(grid);
                resultsEl.appendChild(block);
            };

            // Simple render for now, can be expanded
            renderList('Kết quả tìm kiếm', items);
            
            document.getElementById('exportShareBar').style.display = 'flex';
        });
    </script>
}