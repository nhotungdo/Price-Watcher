@page
@model IndexModel
@{
    ViewData["Title"] = "SƒÉn Sale T·ªët - So s√°nh gi√° t·ªët nh·∫•t";
}

<div class="tiki-homepage">
    <div class="container-fluid px-3 py-3">
        <div class="row g-3">
            <!-- Left Sidebar - Categories -->
            <div class="col-lg-2 d-none d-lg-block">
                <aside class="sidebar-categories-modern">
                    <div class="category-menu-modern">
                        <div class="category-menu-header">
                            <i class="bi bi-grid-3x3-gap-fill"></i>
                            <span>Danh M·ª•c S·∫£n Ph·∫©m</span>
                        </div>
                        <ul class="category-list-modern">
                            <li class="category-item-modern">
                                <a href="/category/electronics" class="category-link-modern">
                                    <div class="category-icon-modern">üì±</div>
                                    <div class="category-text">
                                        <span class="category-name">ƒêi·ªán Tho·∫°i</span>
                                        <span class="category-count">2.5k+</span>
                                    </div>
                                    <i class="bi bi-chevron-right category-arrow"></i>
                                </a>
                            </li>
                            <li class="category-item-modern">
                                <a href="/category/laptop" class="category-link-modern">
                                    <div class="category-icon-modern">üíª</div>
                                    <div class="category-text">
                                        <span class="category-name">Laptop & IT</span>
                                        <span class="category-count">1.8k+</span>
                                    </div>
                                    <i class="bi bi-chevron-right category-arrow"></i>
                                </a>
                            </li>
                            <li class="category-item-modern">
                                <a href="/category/camera" class="category-link-modern">
                                    <div class="category-icon-modern">üì∑</div>
                                    <div class="category-text">
                                        <span class="category-name">M√°y ·∫¢nh</span>
                                        <span class="category-count">890+</span>
                                    </div>
                                    <i class="bi bi-chevron-right category-arrow"></i>
                                </a>
                            </li>
                            <li class="category-item-modern">
                                <a href="/category/audio" class="category-link-modern">
                                    <div class="category-icon-modern">üéß</div>
                                    <div class="category-text">
                                        <span class="category-name">√Çm Thanh</span>
                                        <span class="category-count">1.2k+</span>
                                    </div>
                                    <i class="bi bi-chevron-right category-arrow"></i>
                                </a>
                            </li>
                            <li class="category-item-modern">
                                <a href="/category/watch" class="category-link-modern">
                                    <div class="category-icon-modern">‚åö</div>
                                    <div class="category-text">
                                        <span class="category-name">ƒê·ªìng H·ªì</span>
                                        <span class="category-count">650+</span>
                                    </div>
                                    <i class="bi bi-chevron-right category-arrow"></i>
                                </a>
                            </li>
                            <li class="category-item-modern">
                                <a href="/category/home" class="category-link-modern">
                                    <div class="category-icon-modern">üè†</div>
                                    <div class="category-text">
                                        <span class="category-name">Nh√† C·ª≠a</span>
                                        <span class="category-count">3.1k+</span>
                                    </div>
                                    <i class="bi bi-chevron-right category-arrow"></i>
                                </a>
                            </li>
                            <li class="category-item-modern">
                                <a href="/category/books" class="category-link-modern">
                                    <div class="category-icon-modern">üìö</div>
                                    <div class="category-text">
                                        <span class="category-name">S√°ch</span>
                                        <span class="category-count">5.4k+</span>
                                    </div>
                                    <i class="bi bi-chevron-right category-arrow"></i>
                                </a>
                            </li>
                            <li class="category-item-modern">
                                <a href="/category/fashion" class="category-link-modern">
                                    <div class="category-icon-modern">üëï</div>
                                    <div class="category-text">
                                        <span class="category-name">Th·ªùi Trang</span>
                                        <span class="category-count">4.2k+</span>
                                    </div>
                                    <i class="bi bi-chevron-right category-arrow"></i>
                                </a>
                            </li>
                        </ul>
                        <a href="/categories" class="view-all-categories">
                            <i class="bi bi-grid"></i>
                            Xem t·∫•t c·∫£ danh m·ª•c
                        </a>
                    </div>
                </aside>
            </div>

            <!-- Main Content Area -->
            <div class="col-lg-10">


                <!-- Hero Banner with Visual Search -->
                <div class="hero-banner-modern mb-3">
                    <div class="hero-content">
                        <div class="hero-badge">
                            <i class="bi bi-stars"></i>
                            <span>T√≠nh nƒÉng m·ªõi</span>
                        </div>
                        <h1 class="hero-title">T√¨m Ki·∫øm B·∫±ng H√¨nh ·∫¢nh</h1>
                        <p class="hero-description">
                            Ch·ª•p ho·∫∑c t·∫£i l√™n h√¨nh ·∫£nh s·∫£n ph·∫©m, ch√∫ng t√¥i s·∫Ω t√¨m gi√° t·ªët nh·∫•t t·ª´ 
                            <strong>Shopee</strong>, <strong>Tiki</strong>, <strong>Lazada</strong>
                        </p>
                        <div class="hero-actions">
                            <a href="/VisualSearch" class="btn-hero-primary">
                                <i class="bi bi-camera-fill"></i>
                                T√¨m ki·∫øm ngay
                            </a>
                            <a href="/MultiSearch" class="btn-hero-secondary">
                                <i class="bi bi-search"></i>
                                T√¨m ki·∫øm vƒÉn b·∫£n
                            </a>
                        </div>
                        <div class="hero-stats">
                            <div class="stat-item">
                                <div class="stat-value">2.5M+</div>
                                <div class="stat-label">S·∫£n ph·∫©m</div>
                            </div>
                            <div class="stat-divider"></div>
                            <div class="stat-item">
                                <div class="stat-value">3</div>
                                <div class="stat-label">S√†n TMƒêT</div>
                            </div>
                            <div class="stat-divider"></div>
                            <div class="stat-item">
                                <div class="stat-value">24/7</div>
                                <div class="stat-label">C·∫≠p nh·∫≠t gi√°</div>
                            </div>
                        </div>
                    </div>
                    <div class="hero-visual">
                        <div class="hero-image-wrapper">
                            <div class="floating-card card-1">
                                <i class="bi bi-phone-fill"></i>
                            </div>
                            <div class="floating-card card-2">
                                <i class="bi bi-laptop-fill"></i>
                            </div>
                            <div class="floating-card card-3">
                                <i class="bi bi-camera-fill"></i>
                            </div>
                            <div class="hero-circle circle-1"></div>
                            <div class="hero-circle circle-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Quick Action Cards -->
                <div class="quick-actions-grid mb-3">
                    <a href="/MultiSearch" class="quick-action-card">
                        <div class="quick-action-icon" style="background: linear-gradient(135deg, #1a94ff 0%, #0d6efd 100%);">
                            <i class="bi bi-search"></i>
                        </div>
                        <div class="quick-action-content">
                            <h3 class="quick-action-title">T√¨m Ki·∫øm ƒêa S√†n</h3>
                            <p class="quick-action-desc">So s√°nh gi√° tr√™n nhi·ªÅu s√†n</p>
                        </div>
                        <i class="bi bi-arrow-right quick-action-arrow"></i>
                    </a>
                    <a href="/VisualSearch" class="quick-action-card">
                        <div class="quick-action-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="bi bi-camera-fill"></i>
                        </div>
                        <div class="quick-action-content">
                            <h3 class="quick-action-title">T√¨m B·∫±ng H√¨nh ·∫¢nh</h3>
                            <p class="quick-action-desc">Ch·ª•p ·∫£nh ƒë·ªÉ t√¨m s·∫£n ph·∫©m</p>
                        </div>
                        <i class="bi bi-arrow-right quick-action-arrow"></i>
                    </a>
                    <a href="/Categories" class="quick-action-card">
                        <div class="quick-action-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <i class="bi bi-grid-3x3-gap-fill"></i>
                        </div>
                        <div class="quick-action-content">
                            <h3 class="quick-action-title">Danh M·ª•c</h3>
                            <p class="quick-action-desc">Kh√°m ph√° theo danh m·ª•c</p>
                        </div>
                        <i class="bi bi-arrow-right quick-action-arrow"></i>
                    </a>
                    <a href="/Cart" class="quick-action-card">
                        <div class="quick-action-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <i class="bi bi-cart-fill"></i>
                        </div>
                        <div class="quick-action-content">
                            <h3 class="quick-action-title">Gi·ªè H√†ng</h3>
                            <p class="quick-action-desc">Xem s·∫£n ph·∫©m ƒë√£ l∆∞u</p>
                        </div>
                        <i class="bi bi-arrow-right quick-action-arrow"></i>
                    </a>
                </div>

                <!-- Search History Section -->
                <section class="search-history-section mb-3" id="searchHistorySection" style="display: none;">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-clock-history"></i> L·ªãch s·ª≠ t√¨m ki·∫øm
                                </h5>
                                <button class="btn btn-sm btn-outline-danger" id="btnClearHistory">
                                    <i class="bi bi-trash"></i> X√≥a t·∫•t c·∫£
                                </button>
                            </div>
                            <div id="searchHistoryContainer" class="search-history-list">
                                <!-- History items will be loaded here -->
                            </div>
                            <div id="searchHistoryEmpty" class="text-center text-muted py-3" style="display: none;">
                                <i class="bi bi-search" style="font-size: 2rem;"></i>
                                <p class="mb-0 mt-2">Ch∆∞a c√≥ l·ªãch s·ª≠ t√¨m ki·∫øm</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Crawl Input Section -->
                <section class="crawl-section mb-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Theo d√µi gi√° s·∫£n ph·∫©m Tiki</h5>
                            <div class="input-group mb-3">
                                <input type="text" id="crawlUrlInput" class="form-control"
                                    placeholder="D√°n link s·∫£n ph·∫©m Tiki v√†o ƒë√¢y (v√≠ d·ª•: https://tiki.vn/iphone-15-p271966088.html)"
                                    aria-label="Tiki URL">
                                <button class="btn btn-primary" type="button" id="btnCrawl">
                                    <span id="crawlSpinner" class="spinner-border spinner-border-sm d-none"
                                        role="status" aria-hidden="true"></span>
                                    Theo d√µi ngay
                                </button>
                            </div>
                            <div id="crawlResult" class="d-none">
                                <div class="alert alert-success d-flex align-items-center" role="alert">
                                    <img id="previewImage" src="" alt="Preview" class="me-3"
                                        style="width: 50px; height: 50px; object-fit: cover;">
                                    <div>
                                        <h6 id="previewTitle" class="mb-0"></h6>
                                        <div class="small">
                                            <span id="previewPrice" class="fw-bold text-danger"></span>
                                            <span id="previewMessage" class="text-muted ms-2"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="crawlError" class="alert alert-danger d-none" role="alert"></div>
                        </div>
                    </div>
                </section>

                <!-- Flash Deal Section -->
                <section class="flash-deal-section-wrapper mb-3">
                    <div class="flash-deal-section">
                        <div class="flash-deal-header">
                            <h2 class="flash-deal-title">
                                <span class="flash-icon">‚ö°</span>
                                Flash Sale H√¥m Nay
                            </h2>
                            <div class="countdown-timer">
                                <span class="countdown-label">K·∫øt th√∫c sau:</span>
                                <div class="countdown-item">
                                    <span class="countdown-value" id="hours">02</span>
                                    <span class="countdown-unit">Gi·ªù</span>
                                </div>
                                <div class="countdown-item">
                                    <span class="countdown-value" id="minutes">30</span>
                                    <span class="countdown-unit">Ph√∫t</span>
                                </div>
                                <div class="countdown-item">
                                    <span class="countdown-value" id="seconds">45</span>
                                    <span class="countdown-unit">Gi√¢y</span>
                                </div>
                            </div>
                        </div>
                        <div class="deal-products">
                            <!-- Deal products will be loaded here -->
                        </div>
                    </div>
                </section>

                <!-- Product Showcase -->
                <section class="product-showcase">
                    <div class="section-header">
                        <h2 class="section-title">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                            </svg>
                            G·ª£i √ù H√¥m Nay
                        </h2>
                        <span id="personalBadge" class="badge badge-personal ms-2 d-none">C√° nh√¢n h√≥a</span>
                        <a href="/products" class="view-all-link">
                            Xem t·∫•t c·∫£
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </a>
                    </div>

                    <div id="personalFallback" class="alert alert-personal d-none small" role="alert">
                        H√£y ƒëƒÉng nh·∫≠p ƒë·ªÉ nh·∫≠n g·ª£i √Ω theo l·ªãch s·ª≠. ƒêang hi·ªÉn th·ªã g·ª£i √Ω chung.
                    </div>

                    <!-- Platform Filter Tabs -->
                    <div class="platform-tabs mb-3">
                        <button class="platform-tab active" data-platform="personal">
                            <span>Theo l·ªãch s·ª≠</span>
                        </button>
                        <button class="platform-tab" data-platform="all">
                            <span>T·∫•t c·∫£</span>
                        </button>
                        <button class="platform-tab" data-platform="tiki">
                            <span>Tiki</span>
                        </button>
                        <button class="platform-tab" data-platform="shopee">
                            <span>Shopee</span>
                        </button>
                        
                    </div>


                    <div class="row g-3" id="featuredProductsContainer">
                        <!-- Products will be loaded here via JS -->
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mt-4">
                    <div class="section-header">
                        <h2 class="section-title">Danh M·ª•c N·ªïi B·∫≠t</h2>
                    </div>
                    <div class="row g-3">
                        <div class="col-6 col-md-3">
                            <a href="/category/electronics"
                                class="ad-sub-card d-flex align-items-center justify-content-center"
                                style="height: 120px; font-size: 48px;">
                                üì±
                            </a>
                        </div>
                        <div class="col-6 col-md-3">
                            <a href="/category/laptop"
                                class="ad-sub-card d-flex align-items-center justify-content-center"
                                style="height: 120px; font-size: 48px;">
                                üíª
                            </a>
                        </div>
                        <div class="col-6 col-md-3">
                            <a href="/category/fashion"
                                class="ad-sub-card d-flex align-items-center justify-content-center"
                                style="height: 120px; font-size: 48px;">
                                üëï
                            </a>
                        </div>
                        <div class="col-6 col-md-3">
                            <a href="/category/home"
                                class="ad-sub-card d-flex align-items-center justify-content-center"
                                style="height: 120px; font-size: 48px;">
                                üè†
                            </a>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/homepage.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadSearchHistory();
            loadSuggestedProducts('personal');

            const btnCrawl = document.getElementById('btnCrawl');
            const inputUrl = document.getElementById('crawlUrlInput');
            const crawlResult = document.getElementById('crawlResult');
            const crawlError = document.getElementById('crawlError');
            const spinner = document.getElementById('crawlSpinner');

            btnCrawl.addEventListener('click', async function () {
                const url = inputUrl.value.trim();

                if (!url) {
                    showError('Vui l√≤ng nh·∫≠p URL s·∫£n ph·∫©m Tiki');
                    return;
                }

                // Show loading
                spinner.classList.remove('d-none');
                btnCrawl.disabled = true;
                crawlResult.classList.add('d-none');
                crawlError.classList.add('d-none');

                try {
                    const response = await fetch('/api/crawl/tiki', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ url: url })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Show preview
                        document.getElementById('previewImage').src = data.imageUrl || '';
                        document.getElementById('previewTitle').textContent = data.name || '';
                        document.getElementById('previewPrice').textContent = formatPrice(data.price);
                        document.getElementById('previewMessage').textContent = data.message || 'ƒê√£ th√™m v√†o theo d√µi';
                        crawlResult.classList.remove('d-none');

                        // Reload products after a delay
                        setTimeout(() => loadSuggestedProducts(), 2000);
                    } else {
                        showError(data.message || 'Kh√¥ng th·ªÉ x·ª≠ l√Ω URL n√†y');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showError('ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu');
                } finally {
                    spinner.classList.add('d-none');
                    btnCrawl.disabled = false;
                }
            });

            function showError(message) {
                crawlError.textContent = message;
                crawlError.classList.remove('d-none');
                crawlResult.classList.add('d-none');
            }

            function formatPrice(price) {
                if (!price) return '';
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
            }
        });

        // Platform filter tabs
        let currentPlatform = 'personal';
        document.querySelectorAll('.platform-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.platform-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentPlatform = this.dataset.platform;
                loadSuggestedProducts(currentPlatform);
            });
        });

        async function loadSuggestedProducts(platform = 'all') {
            const container = document.getElementById('featuredProductsContainer');
            container.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            try {
                const endpoint = platform === 'all'
                    ? '/api/home/suggestions?limit=12'
                    : (platform === 'personal' ? '/api/home/suggestions/personal?limit=12' : `/api/home/suggestions/${platform}?limit=12`);
                console.time('home:suggestions');
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error('HTTP ' + response.status);

                const startRender = performance.now();
                const data = await response.json();
                const badge = document.getElementById('personalBadge');
                const fallback = document.getElementById('personalFallback');
                const showBadge = platform === 'personal' && data.source === 'personal';
                const showFallback = platform === 'personal' && data.source === 'fallback';
                if (badge) {
                    badge.classList.toggle('d-none', !showBadge);
                    badge.classList.toggle('fade-in-badge', showBadge);
                }
                if (fallback) {
                    fallback.classList.toggle('d-none', !showFallback);
                    fallback.classList.toggle('fade-in-alert', showFallback);
                }

                if (!data.success || !data.products || data.products.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center text-muted py-5">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o. H√£y th·ª≠ th√™m link Tiki ·ªü tr√™n!</div>';
                    console.timeEnd('home:suggestions');
                    return;
                }

                const products = data.products;

                container.innerHTML = products.map(p => `
                                        <div class="col-6 col-md-4 col-lg-2">
                                            <div class="product-card" 
                                                 data-product-id="${p.productId || ''}"
                                                 data-platform-id="${p.platformId || 0}"
                                                 data-platform-name="${p.platform || ''}"
                                                 data-product-name="${escapeHtml(p.productName || '')}"
                                                 data-product-price="${p.price || 0}"
                                                 data-product-image="${p.imageUrl || ''}"
                                                 data-product-url="${p.productUrl || ''}">
                                                <div class="product-image-wrapper">
                                                    <img src="${p.imageUrl || '/images/placeholder.png'}" alt="${escapeHtml(p.productName || '')}" class="product-image" loading="lazy">
                                                    ${p.discountRate ? `<span class="product-badge">-${p.discountRate}%</span>` : ''}
                                                    <span class="platform-badge platform-${p.platform.toLowerCase()}">${p.platform}</span>
                                                </div>
                                                <div class="product-info">
                                                    <div class="product-name">${escapeHtml(p.productName || '')}</div>
                                                    ${p.rating ? `
                                                    <div class="product-rating">
                                                        <span class="rating-stars">${'‚≠ê'.repeat(Math.round(p.rating))}</span>
                                                        <span class="rating-count">(${p.reviewCount || 0})</span>
                                                    </div>
                                                    ` : ''}
                                                    <div class="product-price-block">
                                                        ${p.originalPrice && p.originalPrice > p.price ? `<span class="product-price-old">${formatPrice(p.originalPrice)}</span>` : ''}
                                                        <span class="product-price">${formatPrice(p.price)}</span>
                                                    </div>
                                                    ${p.isFreeShip ? '<div class="free-ship-badge">Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</div>' : ''}
                                                    <a class="buy-btn" href="${p.productUrl || '#'}" target="_blank" rel="noopener">T·ªõi n∆°i b√°n</a>
                                                </div>
                                            </div>
                                        </div>
                            `).join('');
                const endRender = performance.now();
                console.timeEnd('home:suggestions');
                console.log('home:suggestions:count', products.length, 'renderMs', Math.round(endRender - startRender));

                // Add click handlers
                try {
                    const cards = container.querySelectorAll('.product-card');
                    cards.forEach(card => {
                        const url = card.getAttribute('data-product-url');
                        if (!url) return;
                        card.addEventListener('click', (e) => {
                            if (e.target && e.target.closest('.buy-btn')) return;
                            window.open(url, '_blank', 'noopener');
                        });
                        const buy = card.querySelector('.buy-btn');
                        if (buy) {
                            buy.addEventListener('click', (e) => { e.stopPropagation(); });
                        }
                    });
                } catch { }
            } catch (error) {
                console.error('Error loading products:', error);
                container.innerHTML = '<div class="col-12 text-center text-danger py-5">Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i sau.</div>';
            }
        }

        function formatPrice(price) {
            if (!price) return '0‚Ç´';
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Search History Functions
        async function loadSearchHistory() {
            try {
                const response = await fetch('/api/SearchHistory/recent?limit=5');
                const data = await response.json();

                if (!data.success || !data.history || data.history.length === 0) {
                    // Don't show section if no history
                    document.getElementById('searchHistorySection').style.display = 'none';
                    return;
                }

                const section = document.getElementById('searchHistorySection');
                const container = document.getElementById('searchHistoryContainer');
                const emptyState = document.getElementById('searchHistoryEmpty');

                section.style.display = 'block';
                emptyState.style.display = 'none';

                container.innerHTML = data.history.map(item => `
                    <div class="search-history-item" data-history-id="${item.historyId}">
                        <div class="history-content">
                            <div class="history-icon">
                                ${getSearchTypeIcon(item.searchType)}
                            </div>
                            <div class="history-details">
                                <div class="history-keyword">${escapeHtml(item.keyword || item.inputContent)}</div>
                                <div class="history-meta">
                                    <span class="history-time">${item.timeAgo}</span>
                                    ${item.bestPrice ? `<span class="history-price">${formatPrice(item.bestPrice)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <button class="btn-delete-history" onclick="deleteHistoryItem(${item.historyId})" title="X√≥a">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                `).join('');

                // Add click handlers to search again
                container.querySelectorAll('.search-history-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        if (e.target.closest('.btn-delete-history')) return;
                        const keyword = this.querySelector('.history-keyword').textContent;
                        searchAgain(keyword);
                    });
                });

            } catch (error) {
                console.error('Error loading search history:', error);
                // Hide section on error
                document.getElementById('searchHistorySection').style.display = 'none';
            }
        }

        function getSearchTypeIcon(searchType) {
            const icons = {
                'Link': '<i class="bi bi-link-45deg"></i>',
                'Text': '<i class="bi bi-search"></i>',
                'Image': '<i class="bi bi-image"></i>',
                'Voice': '<i class="bi bi-mic"></i>'
            };
            return icons[searchType] || '<i class="bi bi-search"></i>';
        }

        function searchAgain(keyword) {
            // Redirect to multi-search page with the keyword
            window.location.href = `/MultiSearch?keyword=${encodeURIComponent(keyword)}`;
        }

        async function deleteHistoryItem(historyId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ª•c n√†y kh·ªèi l·ªãch s·ª≠?')) {
                return;
            }

            try {
                const response = await fetch(`/api/SearchHistory/${historyId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    // Reload history
                    await loadSearchHistory();
                } else {
                    alert('Kh√¥ng th·ªÉ x√≥a m·ª•c n√†y');
                }
            } catch (error) {
                console.error('Error deleting history item:', error);
                alert('ƒê√£ x·∫£y ra l·ªói khi x√≥a');
            }
        }

        // Clear all history
        document.getElementById('btnClearHistory')?.addEventListener('click', async function() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ t√¨m ki·∫øm?')) {
                return;
            }

            try {
                const response = await fetch('/api/SearchHistory/clear', {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('searchHistorySection').style.display = 'none';
                } else {
                    alert('Kh√¥ng th·ªÉ x√≥a l·ªãch s·ª≠');
                }
            } catch (error) {
                console.error('Error clearing history:', error);
                alert('ƒê√£ x·∫£y ra l·ªói khi x√≥a l·ªãch s·ª≠');
            }
        });
    </script>
}
