@page
@model IndexModel
@{
    ViewData["Title"] = "SƒÉn Sale T·ªët - So s√°nh gi√° t·ªët nh·∫•t";
}

<div class="tiki-homepage">
    <div class="container-fluid px-3">
        <div class="row g-3">
            <!-- Left Sidebar - Categories -->
            <div class="col-lg-2 d-none d-lg-block">
                <aside class="sidebar-categories">
                    <div class="category-menu">
                        <h6 class="category-menu-title">Danh M·ª•c</h6>
                        <ul class="category-list">
                            <li class="category-item">
                                <a href="/category/electronics" class="category-link">
                                    <i class="category-icon">üì±</i>
                                    <span>ƒêi·ªán Tho·∫°i - MTB</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/laptop" class="category-link">
                                    <i class="category-icon">üíª</i>
                                    <span>Laptop - IT</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/camera" class="category-link">
                                    <i class="category-icon">üì∑</i>
                                    <span>M√°y ·∫¢nh</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/audio" class="category-link">
                                    <i class="category-icon">üéß</i>
                                    <span>√Çm Thanh</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/watch" class="category-link">
                                    <i class="category-icon">‚åö</i>
                                    <span>ƒê·ªìng H·ªì</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/home" class="category-link">
                                    <i class="category-icon">üè†</i>
                                    <span>Nh√† C·ª≠a</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/books" class="category-link">
                                    <i class="category-icon">üìö</i>
                                    <span>S√°ch</span>
                                </a>
                            </li>
                            <li class="category-item">
                                <a href="/category/fashion" class="category-link">
                                    <i class="category-icon">üëï</i>
                                    <span>Th·ªùi Trang</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </aside>
            </div>

            <!-- Main Content Area -->
            <div class="col-lg-10">


                <div class="ad-sub-grid mt-3">
                    <a href="/" class="ad-sub-card">
                        <img src="https://salt.tikicdn.com/cache/w750/ts/tikimsp/ed/da/cb/2815c3eaf1cd4bf2504dec07a89f6801.png.webp"
                            alt="Banner" loading="lazy" />
                    </a>
                    <a href="/" class="ad-sub-card">
                        <img src="https://salt.tikicdn.com/cache/w750/ts/tikimsp/b4/7f/5c/701e99aa954036cdecd449c08c247703.png.webp"
                            alt="Banner" loading="lazy" />
                    </a>
                    <a href="/" class="ad-sub-card">
                        <img src="https://salt.tikicdn.com/cache/w750/ts/tikimsp/4c/f7/39/5a104d7c5dee216a16d0df76a55a7a35.png.webp"
                            alt="Banner" loading="lazy" />
                    </a>
                    <a href="/" class="ad-sub-card">
                        <img src="https://salt.tikicdn.com/cache/w750/ts/tikimsp/91/58/8c/082336ff97bcbaaaf33a818acf85783a.jpg.webp"
                            alt="Banner" loading="lazy" />
                    </a>
                </div>

                <!-- Crawl Input Section -->
                <section class="crawl-section mb-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Theo d√µi gi√° s·∫£n ph·∫©m Tiki</h5>
                            <div class="input-group mb-3">
                                <input type="text" id="crawlUrlInput" class="form-control"
                                    placeholder="D√°n link s·∫£n ph·∫©m Tiki v√†o ƒë√¢y (v√≠ d·ª•: https://tiki.vn/iphone-15-p271966088.html)"
                                    aria-label="Tiki URL">
                                <button class="btn btn-primary" type="button" id="btnCrawl">
                                    <span id="crawlSpinner" class="spinner-border spinner-border-sm d-none"
                                        role="status" aria-hidden="true"></span>
                                    Theo d√µi ngay
                                </button>
                            </div>
                            <div id="crawlResult" class="d-none">
                                <div class="alert alert-success d-flex align-items-center" role="alert">
                                    <img id="previewImage" src="" alt="Preview" class="me-3"
                                        style="width: 50px; height: 50px; object-fit: cover;">
                                    <div>
                                        <h6 id="previewTitle" class="mb-0"></h6>
                                        <div class="small">
                                            <span id="previewPrice" class="fw-bold text-danger"></span>
                                            <span id="previewMessage" class="text-muted ms-2"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="crawlError" class="alert alert-danger d-none" role="alert"></div>
                        </div>
                    </div>
                </section>

                <!-- Flash Deal Section -->
                <section class="flash-deal-section-wrapper mb-3">
                    <div class="flash-deal-section">
                        <div class="flash-deal-header">
                            <h2 class="flash-deal-title">
                                <span class="flash-icon">‚ö°</span>
                                Flash Sale H√¥m Nay
                            </h2>
                            <div class="countdown-timer">
                                <span class="countdown-label">K·∫øt th√∫c sau:</span>
                                <div class="countdown-item">
                                    <span class="countdown-value" id="hours">02</span>
                                    <span class="countdown-unit">Gi·ªù</span>
                                </div>
                                <div class="countdown-item">
                                    <span class="countdown-value" id="minutes">30</span>
                                    <span class="countdown-unit">Ph√∫t</span>
                                </div>
                                <div class="countdown-item">
                                    <span class="countdown-value" id="seconds">45</span>
                                    <span class="countdown-unit">Gi√¢y</span>
                                </div>
                            </div>
                        </div>
                        <div class="deal-products">
                            <!-- Deal products will be loaded here -->
                        </div>
                    </div>
                </section>

                <!-- Product Showcase -->
                <section class="product-showcase">
                    <div class="section-header">
                        <h2 class="section-title">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                            </svg>
                            G·ª£i √ù H√¥m Nay
                        </h2>
                        <span id="personalBadge" class="badge badge-personal ms-2 d-none">C√° nh√¢n h√≥a</span>
                        <a href="/products" class="view-all-link">
                            Xem t·∫•t c·∫£
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </a>
                    </div>

                    <div id="personalFallback" class="alert alert-personal d-none small" role="alert">
                        H√£y ƒëƒÉng nh·∫≠p ƒë·ªÉ nh·∫≠n g·ª£i √Ω theo l·ªãch s·ª≠. ƒêang hi·ªÉn th·ªã g·ª£i √Ω chung.
                    </div>

                    <!-- Platform Filter Tabs -->
                    <div class="platform-tabs mb-3">
                        <button class="platform-tab active" data-platform="personal">
                            <span>Theo l·ªãch s·ª≠</span>
                        </button>
                        <button class="platform-tab" data-platform="all">
                            <span>T·∫•t c·∫£</span>
                        </button>
                        <button class="platform-tab" data-platform="tiki">
                            <span>Tiki</span>
                        </button>
                        <button class="platform-tab" data-platform="shopee">
                            <span>Shopee</span>
                        </button>
                        <button class="platform-tab" data-platform="lazada">
                            <span>Lazada</span>
                        </button>
                    </div>


                    <div class="row g-3" id="featuredProductsContainer">
                        <!-- Products will be loaded here via JS -->
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mt-4">
                    <div class="section-header">
                        <h2 class="section-title">Danh M·ª•c N·ªïi B·∫≠t</h2>
                    </div>
                    <div class="row g-3">
                        <div class="col-6 col-md-3">
                            <a href="/category/electronics"
                                class="ad-sub-card d-flex align-items-center justify-content-center"
                                style="height: 120px; font-size: 48px;">
                                üì±
                            </a>
                        </div>
                        <div class="col-6 col-md-3">
                            <a href="/category/laptop"
                                class="ad-sub-card d-flex align-items-center justify-content-center"
                                style="height: 120px; font-size: 48px;">
                                üíª
                            </a>
                        </div>
                        <div class="col-6 col-md-3">
                            <a href="/category/fashion"
                                class="ad-sub-card d-flex align-items-center justify-content-center"
                                style="height: 120px; font-size: 48px;">
                                üëï
                            </a>
                        </div>
                        <div class="col-6 col-md-3">
                            <a href="/category/home"
                                class="ad-sub-card d-flex align-items-center justify-content-center"
                                style="height: 120px; font-size: 48px;">
                                üè†
                            </a>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/homepage.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadSuggestedProducts('personal');

            const btnCrawl = document.getElementById('btnCrawl');
            const inputUrl = document.getElementById('crawlUrlInput');
            const crawlResult = document.getElementById('crawlResult');
            const crawlError = document.getElementById('crawlError');
            const spinner = document.getElementById('crawlSpinner');

            btnCrawl.addEventListener('click', async function () {
                const url = inputUrl.value.trim();

                if (!url) {
                    showError('Vui l√≤ng nh·∫≠p URL s·∫£n ph·∫©m Tiki');
                    return;
                }

                // Show loading
                spinner.classList.remove('d-none');
                btnCrawl.disabled = true;
                crawlResult.classList.add('d-none');
                crawlError.classList.add('d-none');

                try {
                    const response = await fetch('/api/crawl/tiki', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ url: url })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Show preview
                        document.getElementById('previewImage').src = data.imageUrl || '';
                        document.getElementById('previewTitle').textContent = data.name || '';
                        document.getElementById('previewPrice').textContent = formatPrice(data.price);
                        document.getElementById('previewMessage').textContent = data.message || 'ƒê√£ th√™m v√†o theo d√µi';
                        crawlResult.classList.remove('d-none');

                        // Reload products after a delay
                        setTimeout(() => loadSuggestedProducts(), 2000);
                    } else {
                        showError(data.message || 'Kh√¥ng th·ªÉ x·ª≠ l√Ω URL n√†y');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showError('ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu');
                } finally {
                    spinner.classList.add('d-none');
                    btnCrawl.disabled = false;
                }
            });

            function showError(message) {
                crawlError.textContent = message;
                crawlError.classList.remove('d-none');
                crawlResult.classList.add('d-none');
            }

            function formatPrice(price) {
                if (!price) return '';
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
            }
        });

        // Platform filter tabs
        let currentPlatform = 'personal';
        document.querySelectorAll('.platform-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.platform-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentPlatform = this.dataset.platform;
                loadSuggestedProducts(currentPlatform);
            });
        });

        async function loadSuggestedProducts(platform = 'all') {
            const container = document.getElementById('featuredProductsContainer');
            container.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            try {
                const endpoint = platform === 'all'
                    ? '/api/home/suggestions?limit=12'
                    : (platform === 'personal' ? '/api/home/suggestions/personal?limit=12' : `/api/home/suggestions/${platform}?limit=12`);
                console.time('home:suggestions');
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error('HTTP ' + response.status);

                const startRender = performance.now();
                const data = await response.json();
                const badge = document.getElementById('personalBadge');
                const fallback = document.getElementById('personalFallback');
                const showBadge = platform === 'personal' && data.source === 'personal';
                const showFallback = platform === 'personal' && data.source === 'fallback';
                if (badge) {
                    badge.classList.toggle('d-none', !showBadge);
                    badge.classList.toggle('fade-in-badge', showBadge);
                }
                if (fallback) {
                    fallback.classList.toggle('d-none', !showFallback);
                    fallback.classList.toggle('fade-in-alert', showFallback);
                }

                if (!data.success || !data.products || data.products.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center text-muted py-5">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o. H√£y th·ª≠ th√™m link Tiki ·ªü tr√™n!</div>';
                    console.timeEnd('home:suggestions');
                    return;
                }

                const products = data.products;

                container.innerHTML = products.map(p => `
                                        <div class="col-6 col-md-4 col-lg-2">
                                            <div class="product-card" 
                                                 data-product-id="${p.productId || ''}"
                                                 data-platform-id="${p.platformId || 0}"
                                                 data-platform-name="${p.platform || ''}"
                                                 data-product-name="${escapeHtml(p.productName || '')}"
                                                 data-product-price="${p.price || 0}"
                                                 data-product-image="${p.imageUrl || ''}"
                                                 data-product-url="${p.productUrl || ''}">
                                                <div class="product-image-wrapper">
                                                    <img src="${p.imageUrl || '/images/placeholder.png'}" alt="${escapeHtml(p.productName || '')}" class="product-image" loading="lazy">
                                                    ${p.discountRate ? `<span class="product-badge">-${p.discountRate}%</span>` : ''}
                                                    <span class="platform-badge platform-${p.platform.toLowerCase()}">${p.platform}</span>
                                                </div>
                                                <div class="product-info">
                                                    <div class="product-name">${escapeHtml(p.productName || '')}</div>
                                                    ${p.rating ? `
                                                    <div class="product-rating">
                                                        <span class="rating-stars">${'‚≠ê'.repeat(Math.round(p.rating))}</span>
                                                        <span class="rating-count">(${p.reviewCount || 0})</span>
                                                    </div>
                                                    ` : ''}
                                                    <div class="product-price-block">
                                                        ${p.originalPrice && p.originalPrice > p.price ? `<span class="product-price-old">${formatPrice(p.originalPrice)}</span>` : ''}
                                                        <span class="product-price">${formatPrice(p.price)}</span>
                                                    </div>
                                                    ${p.isFreeShip ? '<div class="free-ship-badge">Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</div>' : ''}
                                                    <a class="buy-btn" href="${p.productUrl || '#'}" target="_blank" rel="noopener">T·ªõi n∆°i b√°n</a>
                                                </div>
                                            </div>
                                        </div>
                            `).join('');
                const endRender = performance.now();
                console.timeEnd('home:suggestions');
                console.log('home:suggestions:count', products.length, 'renderMs', Math.round(endRender - startRender));

                // Add click handlers
                try {
                    const cards = container.querySelectorAll('.product-card');
                    cards.forEach(card => {
                        const url = card.getAttribute('data-product-url');
                        if (!url) return;
                        card.addEventListener('click', (e) => {
                            if (e.target && e.target.closest('.buy-btn')) return;
                            window.open(url, '_blank', 'noopener');
                        });
                        const buy = card.querySelector('.buy-btn');
                        if (buy) {
                            buy.addEventListener('click', (e) => { e.stopPropagation(); });
                        }
                    });
                } catch { }
            } catch (error) {
                console.error('Error loading products:', error);
                container.innerHTML = '<div class="col-12 text-center text-danger py-5">Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i sau.</div>';
            }
        }

        function formatPrice(price) {
            if (!price) return '0‚Ç´';
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
}
